<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0" />
    <title>AR.js GPS Demo</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-assets>
        <a-asset-item
          id="model"
          src="assets/asset.gltf"
        ></a-asset-item>
      </a-assets>

      <a-entity
        id="arModel"
        gltf-model="#model"
        look-at="[gps-camera]"
        scale="2 2 2"
        position="0 0 0"
        gps-entity-place="latitude: 6.820065; longitude: 80.040148;"
      ></a-entity>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // GPS stabilization and location monitoring
      const arModel = document.getElementById('arModel');
      const scene = document.querySelector('a-scene');

      // Fixed target location
      const targetLat = 6.820065;
      const targetLon = 80.040148;

      // GPS monitoring for better stability
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Calculate distance to target
            const R = 6371e3; // Earth's radius in meters
            const φ1 = (userLat * Math.PI) / 180;
            const φ2 = (targetLat * Math.PI) / 180;
            const Δφ = ((targetLat - userLat) * Math.PI) / 180;
            const Δλ = ((targetLon - userLon) * Math.PI) / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            console.log(`GPS Fixed Location: ${targetLat}, ${targetLon}`);
            console.log(`User Location: ${userLat.toFixed(6)}, ${userLon.toFixed(6)}`);
            console.log(`Distance to target: ${distance.toFixed(1)}m`);
            console.log(`GPS Accuracy: ${accuracy.toFixed(1)}m`);

            // Ensure model stays at fixed GPS position
            if (arModel) {
              arModel.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
            }
          },
          (error) => {
            console.error('GPS Error:', error);
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000
          }
        );
      }

      // Scene loaded event
      scene.addEventListener('loaded', () => {
        console.log('AR Scene loaded - Model fixed at GPS coordinates:', targetLat, targetLon);
      });

      // Prevent model from moving due to GPS fluctuations
      setInterval(() => {
        if (arModel) {
          // Reaffirm the fixed position every 5 seconds
          arModel.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
        }
      }, 5000);
    </script>
  </body>
</html>