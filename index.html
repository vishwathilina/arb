<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebAR GPS Model Viewer</title>
  <!-- A-Frame for AR -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for geolocation -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    * { margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; overflow: hidden; }
    a-scene { width: 100%; height: 100vh; }
    
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 10;
      max-width: 200px;
      line-height: 1.5;
    }
    
    #info p { margin: 4px 0; }
    #info span { color: #0f0; font-weight: bold; }
    #status { 
      margin-top: 8px; 
      padding-top: 8px; 
      border-top: 1px solid #666; 
      font-size: 11px;
      color: #fa0;
    }
  </style>
</head>
<body>
  <!-- Info Panel -->
  <div id="info">
    <p>üìç Lat: <span id="lat">--</span></p>
    <p>üìç Lon: <span id="lon">--</span></p>
    <p>üìè Dist: <span id="distance">--</span>m</p>
    <div id="status">Initializing...</div>
  </div>

  <!-- A-Frame AR Scene -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false;">
    
    <!-- GPS-Anchored Model Container -->
    <a-entity id="modelContainer" gps-entity-place="latitude: 6.8206; longitude: 80.0390;" visible="false">
      <!-- Using gltf-model for better GLB support -->
      <a-entity gltf-model="url(assets/logo2.glb)" 
                scale="1 1 1" 
                position="0 0 0"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 8000;"></a-entity>
    </a-entity>

    <!-- Fallback Hiro Marker (for indoor testing without GPS) -->
    <a-marker preset="hiro">
      <a-entity gltf-model="url(assets/logo2.glb)" 
               scale="0.5 0.5 0.5" 
               position="0 0 0"
               animation="property: rotation; to: 0 360 0; loop: true; dur: 8000;"></a-entity>
    </a-marker>

    <!-- Camera with controls removed for AR -->
    <a-entity camera></a-entity>
    
  </a-scene>

  <script>
    // Configuration
    const TARGET_LAT = 6.8206;
    const TARGET_LON = 80.0390;
    const TRIGGER_RADIUS = 50; // meters

    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const distEl = document.getElementById('distance');
    const statusEl = document.getElementById('status');
    const modelContainer = document.getElementById('modelContainer');

    console.log('AR Script loaded');

    // Calculate distance between two GPS points (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const œÜ1 = (lat1 * Math.PI) / 180;
      const œÜ2 = (lat2 * Math.PI) / 180;
      const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
      const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

      return R * c; // Distance in meters
    }

    // Update UI display and show/hide model
    function updateDisplay(lat, lon, distance) {
      latEl.textContent = lat.toFixed(4);
      lonEl.textContent = lon.toFixed(4);
      distEl.textContent = distance.toFixed(1);

      const inRange = distance <= TRIGGER_RADIUS;

      // Show/hide 3D model based on distance
      if (modelContainer) {
        modelContainer.setAttribute('visible', inRange);
      }

      if (inRange) {
        statusEl.innerHTML = '‚úÖ <b>VISIBLE!</b><br>3D appears now';
        statusEl.style.color = '#0f0';
      } else {
        const remaining = (distance - TRIGGER_RADIUS).toFixed(0);
        statusEl.innerHTML = `üìç Closer needed<br><b>${remaining}m away</b>`;
        statusEl.style.color = '#fa0';
      }

      console.log(`Distance: ${distance.toFixed(1)}m | In range: ${inRange}`);
    }

    // Start GPS tracking
    if (navigator.geolocation) {
      statusEl.innerHTML = 'üìç Getting GPS...';
      statusEl.style.color = '#aaf';
      console.log('Starting GPS watch...');

      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;
          const dist = calculateDistance(lat, lon, TARGET_LAT, TARGET_LON);
          
          updateDisplay(lat, lon, dist);
          console.log(`GPS: ${lat.toFixed(4)}, ${lon.toFixed(4)} | Accuracy: ${acc.toFixed(0)}m | Distance: ${dist.toFixed(1)}m`);
        },
        (err) => {
          let msg = 'GPS Error';
          if (err.code === 1) msg = 'Permission denied - allow location';
          else if (err.code === 2) msg = 'Position unavailable - try outdoors';
          else if (err.code === 3) msg = 'Location timeout';
          
          statusEl.innerHTML = `‚ùå ${msg}`;
          statusEl.style.color = '#f44';
          console.error('Geolocation error:', err);
        },
        { 
          enableHighAccuracy: true, 
          maximumAge: 0, 
          timeout: 5000 
        }
      );
    } else {
      statusEl.innerHTML = '‚ùå GPS not supported';
      statusEl.style.color = '#f44';
      console.error('Geolocation not available');
    }
  </script>
</body>
</html>
