<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0" />
    <title>AR.js GPS Demo</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; gpsMinDistance: 5;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-assets>
        <a-asset-item
          id="model"
          src="assets/asset.gltf"
        ></a-asset-item>
      </a-assets>

      <a-entity
        id="arModel"
        gltf-model="#model"
        look-at="[gps-camera]"
        scale="2 2 2"
        gps-entity-place="latitude: 6.821382; longitude: 80.038355;"
        position="0 0 0"
      ></a-entity>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      // Target GPS coordinates (NSBM Campus)
      const targetLat = 6.821382;
      const targetLon = 80.038355;
      
      window.addEventListener('load', () => {
        const scene = document.querySelector('a-scene');
        const model = document.querySelector('#arModel');
        
        // Wait for AR.js to initialize
        scene.addEventListener('gps-camera-update-position', (event) => {
          const currentLat = event.detail.position.latitude;
          const currentLon = event.detail.position.longitude;
          
          console.log(`Camera GPS: ${currentLat}, ${currentLon}`);
          console.log(`Target GPS: ${targetLat}, ${targetLon}`);
          
          // Calculate distance to target
          const distance = calculateDistance(currentLat, currentLon, targetLat, targetLon);
          console.log(`Distance to target: ${distance.toFixed(2)} meters`);
        });
        
        // Force the model to stay at exact coordinates
        if (model) {
          // Continuously reaffirm the GPS position
          setInterval(() => {
            model.setAttribute('gps-entity-place', {
              latitude: targetLat,
              longitude: targetLon
            });
          }, 1000); // Update every second
          
          console.log('GPS position stabilization active');
        }
      });
      
      // Haversine formula to calculate distance between two GPS coordinates
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth's radius in meters
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        
        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        
        return R * c; // Distance in meters
      }
    </script>
  </body>
</html>