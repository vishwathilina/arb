<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <title>AR Location Viewer</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        
        <style>
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
            
            body {
                margin: 0;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                position: fixed;
                width: 100%;
                height: 100%;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Control Panel - Mobile Optimized */
            #controlPanel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                border-radius: 20px 20px 0 0;
                padding: 20px;
                box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-height: 70vh;
                overflow-y: auto;
                transition: transform 0.3s ease;
                touch-action: pan-y;
            }
            
            #controlPanel.hidden {
                transform: translateY(100%);
            }
            
            #controlPanel h2 {
                margin: 0 0 15px 0;
                font-size: 18px;
                color: #333;
                font-weight: 600;
                text-align: center;
            }
            
            .control-group {
                margin-bottom: 20px;
            }
            
            .control-group label {
                display: block;
                font-size: 14px;
                color: #666;
                margin-bottom: 8px;
                font-weight: 500;
            }
            
            .control-group input[type="number"],
            .control-group input[type="text"] {
                width: 100%;
                padding: 12px 14px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
                box-sizing: border-box;
                -webkit-appearance: none;
                appearance: none;
            }
            
            .control-group input[type="number"]:focus,
            .control-group input[type="text"]:focus {
                border-color: #0084ff;
                outline: none;
            }
            
            .control-group input[type="range"] {
                width: 100%;
                height: 40px;
                margin-top: 5px;
                -webkit-appearance: none;
                appearance: none;
                background: transparent;
            }
            
            .control-group input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 24px;
                height: 24px;
                background: #0084ff;
                border-radius: 50%;
                cursor: pointer;
            }
            
            .control-group input[type="range"]::-webkit-slider-runnable-track {
                width: 100%;
                height: 6px;
                background: #ddd;
                border-radius: 3px;
            }
            
            .value-display {
                font-size: 15px;
                color: #0084ff;
                font-weight: 700;
                margin-left: 5px;
            }
            
            .button-group {
                display: flex;
                gap: 10px;
                margin-top: 20px;
            }
            
            button {
                flex: 1;
                padding: 14px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                touch-action: manipulation;
            }
            
            .btn-primary {
                background: #0084ff;
                color: white;
            }
            
            .btn-primary:active {
                transform: scale(0.95);
                background: #0066cc;
            }
            
            .btn-secondary {
                background: #f0f0f0;
                color: #333;
            }
            
            .btn-secondary:active {
                transform: scale(0.95);
                background: #e0e0e0;
            }
            
            /* Toggle Button - Mobile Optimized */
            #toggleBtn {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #0084ff;
                color: white;
                border: none;
                padding: 18px;
                border-radius: 50%;
                font-size: 24px;
                cursor: pointer;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
                z-index: 10001;
                transition: transform 0.2s, background 0.2s;
                touch-action: manipulation;
                width: 64px;
                height: 64px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            #toggleBtn:active {
                transform: scale(0.9);
            }
            
            /* Info Display - Mobile Optimized */
            #info {
                position: fixed;
                top: 15px;
                left: 15px;
                right: 15px;
                background: rgba(0, 0, 0, 0.85);
                color: white;
                padding: 12px 15px;
                border-radius: 12px;
                font-size: 13px;
                z-index: 9999;
                max-width: none;
            }
            
            #info p {
                margin: 4px 0;
            }
            
            #info strong {
                color: #4fc3f7;
            }
            
            /* Safe area for notch devices */
            @supports(padding: max(0px)) {
                #info {
                    padding-left: max(15px, env(safe-area-inset-left));
                    padding-right: max(15px, env(safe-area-inset-right));
                    padding-top: max(15px, env(safe-area-inset-top));
                }
                
                #toggleBtn {
                    bottom: max(20px, env(safe-area-inset-bottom));
                    right: max(20px, env(safe-area-inset-right));
                }
                
                #controlPanel {
                    padding-bottom: max(20px, env(safe-area-inset-bottom));
                }
            }
        </style>
    </head>

    <body>
        <!-- Toggle Button -->
        <button id="toggleBtn">‚öôÔ∏è</button>
        
        <!-- Info Display -->
        <div id="info">
            <p><strong>üì± AR Camera Active</strong></p>
            <p id="statusText">Status: Ready</p>
            <p id="distanceText">Distance: ‚Äî</p>
        </div>
        
        <!-- Control Panel -->
        <div id="controlPanel" class="hidden">
            <h2>üéõÔ∏è AR Controls</h2>
            
            <div class="control-group">
                <label>Latitude</label>
                <input type="number" id="latInput" value="6.819446" step="0.000001">
            </div>
            
            <div class="control-group">
                <label>Longitude</label>
                <input type="number" id="lonInput" value="80.040257" step="0.000001">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="heightVal">0m</span></label>
                <input type="range" id="heightSlider" min="-5" max="20" step="0.5" value="0">
            </div>
            
            <div class="control-group">
                <label>Scale: <span class="value-display" id="scaleVal">200</span></label>
                <input type="range" id="scaleSlider" min="50" max="500" step="10" value="200">
            </div>
            
            <div class="button-group">
                <button class="btn-primary" id="applyBtn">Apply Changes</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>
            </div>
        </div>

        <a-scene
            renderer="logarithmicDepthBuffer: true;"
            embedded
            loading-screen="enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false;"
        >
            <a-assets>
                <a-asset-item
                    id="animated-asset"
                    src="assets/asset.glb"
                ></a-asset-item>
            </a-assets>

            <a-entity
                id="arModel"
                look-at="[gps-camera]"
                animation-mixer="loop: repeat"
                gltf-model="assets/asset.glb"
                scale="200 200 200"
                position="0 0 0"
                gps-entity-place="latitude: 6.819446; longitude: 80.040257;"
            ></a-entity>

            <a-camera gps-camera rotation-reader></a-camera>
        </a-scene>

        <script>
            // Elements
            const toggleBtn = document.getElementById('toggleBtn');
            const controlPanel = document.getElementById('controlPanel');
            const latInput = document.getElementById('latInput');
            const lonInput = document.getElementById('lonInput');
            const heightSlider = document.getElementById('heightSlider');
            const scaleSlider = document.getElementById('scaleSlider');
            const heightVal = document.getElementById('heightVal');
            const scaleVal = document.getElementById('scaleVal');
            const applyBtn = document.getElementById('applyBtn');
            const resetBtn = document.getElementById('resetBtn');
            const arModel = document.getElementById('arModel');
            const statusText = document.getElementById('statusText');
            
            let panelVisible = false; // Start hidden on mobile
            
            // Default values
            const defaults = {
                lat: 6.819446,
                lon: 80.040257,
                height: 0,
                scale: 200
            };
            
            // Prevent default touch behaviors on panel
            controlPanel.addEventListener('touchmove', (e) => {
                e.stopPropagation();
            }, { passive: false });
            
            // Toggle panel visibility
            toggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                panelVisible = !panelVisible;
                if (panelVisible) {
                    controlPanel.classList.remove('hidden');
                    toggleBtn.textContent = '‚úï';
                } else {
                    controlPanel.classList.add('hidden');
                    toggleBtn.textContent = '‚öôÔ∏è';
                }
            });
            
            // Update value displays
            heightSlider.addEventListener('input', (e) => {
                heightVal.textContent = e.target.value + 'm';
            });
            
            scaleSlider.addEventListener('input', (e) => {
                scaleVal.textContent = e.target.value;
            });
            
            // Apply changes
            applyBtn.addEventListener('click', () => {
                const lat = parseFloat(latInput.value);
                const lon = parseFloat(lonInput.value);
                const height = parseFloat(heightSlider.value);
                const scale = parseFloat(scaleSlider.value);
                
                // Update GPS position
                arModel.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);
                
                // Update position (height)
                arModel.setAttribute('position', `0 ${height} 0`);
                
                // Update scale
                arModel.setAttribute('scale', `${scale} ${scale} ${scale}`);
                
                statusText.textContent = 'Status: Updated ‚úì';
                console.log(`Updated: Lat=${lat}, Lon=${lon}, Height=${height}m, Scale=${scale}`);
                
                // Reset status after 2 seconds
                setTimeout(() => {
                    statusText.textContent = 'Status: Ready';
                }, 2000);
            });
            
            // Reset to defaults
            resetBtn.addEventListener('click', () => {
                latInput.value = defaults.lat;
                lonInput.value = defaults.lon;
                heightSlider.value = defaults.height;
                scaleSlider.value = defaults.scale;
                heightVal.textContent = defaults.height + 'm';
                scaleVal.textContent = defaults.scale;
                
                // Apply defaults
                arModel.setAttribute('gps-entity-place', `latitude: ${defaults.lat}; longitude: ${defaults.lon}`);
                arModel.setAttribute('position', `0 ${defaults.height} 0`);
                arModel.setAttribute('scale', `${defaults.scale} ${defaults.scale} ${defaults.scale}`);
                
                statusText.textContent = 'Status: Reset ‚úì';
                console.log('Reset to default values');
                
                setTimeout(() => {
                    statusText.textContent = 'Status: Ready';
                }, 2000);
            });
            
            // Log when scene loads
            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', () => {
                console.log('AR scene loaded');
                statusText.textContent = 'Status: Scene loaded ‚úì';
            });
            
            // Track user location for distance calculation
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const targetLat = parseFloat(latInput.value);
                        const targetLon = parseFloat(lonInput.value);
                        
                        // Calculate distance (Haversine)
                        const R = 6371e3;
                        const œÜ1 = (userLat * Math.PI) / 180;
                        const œÜ2 = (targetLat * Math.PI) / 180;
                        const ŒîœÜ = ((targetLat - userLat) * Math.PI) / 180;
                        const ŒîŒª = ((targetLon - userLon) * Math.PI) / 180;
                        
                        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const distance = R * c;
                        
                        document.getElementById('distanceText').textContent = 
                            `Distance: ${distance.toFixed(1)}m`;
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true }
                );
            }
        </script>
    </body>
</html>
