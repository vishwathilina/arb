<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>AR Location Viewer</title>
        <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
        <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
        <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
        <script src="https://unpkg.com/aframe-camera-controls@1.0.0/dist/aframe-camera-controls.min.js"></script>
        
        <style>
            body {
                margin: 0;
                overflow: hidden;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            }
            
            /* Control Panel */
            #controlPanel {
                position: fixed;
                top: 15px;
                right: 15px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 320px;
                transition: transform 0.3s ease, opacity 0.3s ease;
            }
            
            #controlPanel.hidden {
                transform: translateX(350px);
                opacity: 0;
                pointer-events: none;
            }
            
            #controlPanel h2 {
                margin: 0 0 12px 0;
                font-size: 16px;
                color: #333;
                font-weight: 600;
            }
            
            .control-group {
                margin-bottom: 15px;
            }
            
            .control-group label {
                display: block;
                font-size: 13px;
                color: #666;
                margin-bottom: 5px;
                font-weight: 500;
            }
            
            .control-group input[type="number"],
            .control-group input[type="text"] {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .control-group input[type="range"] {
                width: 100%;
                margin-top: 5px;
            }
            
            .value-display {
                font-size: 13px;
                color: #0084ff;
                font-weight: 600;
                margin-left: 5px;
            }
            
            .button-group {
                display: flex;
                gap: 8px;
                margin-top: 15px;
            }
            
            button {
                flex: 1;
                padding: 10px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .btn-primary {
                background: #0084ff;
                color: white;
            }
            
            .btn-primary:active {
                transform: scale(0.95);
                background: #0066cc;
            }
            
            .btn-secondary {
                background: #f0f0f0;
                color: #333;
            }
            
            .btn-secondary:active {
                transform: scale(0.95);
                background: #e0e0e0;
            }
            
            /* Toggle Button */
            #toggleBtn {
                position: fixed;
                top: 15px;
                right: 15px;
                background: #0084ff;
                color: white;
                border: none;
                padding: 12px 18px;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                transition: transform 0.2s, background 0.2s;
            }
            
            #toggleBtn:active {
                transform: scale(0.9);
            }
            
            #toggleBtn.panel-visible {
                right: 350px;
            }
            
            /* Info Display */
            #info {
                position: fixed;
                bottom: 15px;
                left: 15px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 15px;
                border-radius: 10px;
                font-size: 12px;
                z-index: 9999;
                max-width: 250px;
            }
            
            #info p {
                margin: 4px 0;
            }
            
            /* Responsive Design */
            @media (max-width: 768px) {
                #controlPanel {
                    position: fixed;
                    top: auto;
                    bottom: 15px;
                    left: 15px;
                    right: 15px;
                    max-width: none;
                    width: calc(100vw - 30px);
                    max-height: 60vh;
                    overflow-y: auto;
                }
                
                #controlPanel.hidden {
                    transform: translateY(100vh);
                    opacity: 0;
                    pointer-events: none;
                }
                
                #toggleBtn {
                    position: fixed;
                    top: auto;
                    bottom: 15px;
                    right: 15px;
                    left: auto;
                }
                
                #toggleBtn.panel-visible {
                    right: auto;
                    left: 15px;
                }
                
                #info {
                    position: fixed;
                    bottom: auto;
                    top: 15px;
                    left: 15px;
                    right: 15px;
                    max-width: none;
                    width: calc(100vw - 30px);
                }
            }
            
            @media (max-width: 480px) {
                #controlPanel {
                    padding: 12px;
                    max-height: 50vh;
                }
                
                #controlPanel h2 {
                    font-size: 14px;
                    margin-bottom: 10px;
                }
                
                .control-group {
                    margin-bottom: 12px;
                }
                
                .control-group label {
                    font-size: 12px;
                }
                
                .control-group input[type="number"],
                .control-group input[type="text"] {
                    padding: 6px 8px;
                    font-size: 13px;
                }
                
                .value-display {
                    font-size: 12px;
                }
                
                button {
                    padding: 8px;
                    font-size: 13px;
                }
                
                #toggleBtn {
                    padding: 10px 14px;
                    font-size: 18px;
                }
                
                #info {
                    padding: 10px 12px;
                    font-size: 11px;
                }
            }
        </style>
    </head>

    <body>
        <!-- Toggle Button -->
        <button id="toggleBtn" class="panel-visible">‚öôÔ∏è</button>
        
        <!-- Control Panel -->
        <div id="controlPanel">
            <h2>üéõÔ∏è AR Controls</h2>
            
            <div class="control-group">
                <label>Latitude</label>
                <input type="number" id="latInput" value="6.819446" step="0.000001">
            </div>
            
            <div class="control-group">
                <label>Longitude</label>
                <input type="number" id="lonInput" value="80.040257" step="0.000001">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="heightVal">0m</span></label>
                <input type="range" id="heightSlider" min="-5" max="20" step="0.5" value="0">
            </div>
            
            <div class="control-group">
                <label>Scale: <span class="value-display" id="scaleVal">200</span></label>
                <input type="range" id="scaleSlider" min="50" max="500" step="10" value="200">
            </div>
            
            <div class="button-group">
                <button class="btn-primary" id="applyBtn">Apply Changes</button>
                <button class="btn-secondary" id="resetBtn">Reset</button>
            </div>
        </div>
        
        <!-- Info Display -->
        <div id="info">
            <p><strong>üì± AR Camera Active</strong></p>
            <p id="statusText">Status: Ready</p>
            <p id="distanceText">Distance: ‚Äî</p>
        </div>

        <a-scene
            renderer="logarithmicDepthBuffer: true;"
            embedded
            loading-screen="enabled: false;"
            arjs="sourceType: webcam; debugUIEnabled: false;"
        >
            <a-assets>
                <a-asset-item
                    id="animated-asset"
                    src="assets/asset.glb"
                ></a-asset-item>
            </a-assets>

            <a-entity
                id="arModel"
                look-at="[gps-camera]"
                animation-mixer="loop: repeat"
                gltf-model="assets/asset.glb"
                scale="200 200 200"
                position="0 0 0"
                gps-entity-place="latitude: 6.819446; longitude: 80.040257;"
            ></a-entity>

            <a-camera 
                gps-camera 
                rotation-reader
                camera-controls="enabled: true; zoomEnabled: true; minDistance: 1; maxDistance: 100"
                zoom-controls="enabled: true"
            ></a-camera>
        </a-scene>

        <script>
            // Elements
            const toggleBtn = document.getElementById('toggleBtn');
            const controlPanel = document.getElementById('controlPanel');
            const latInput = document.getElementById('latInput');
            const lonInput = document.getElementById('lonInput');
            const heightSlider = document.getElementById('heightSlider');
            const scaleSlider = document.getElementById('scaleSlider');
            const heightVal = document.getElementById('heightVal');
            const scaleVal = document.getElementById('scaleVal');
            const applyBtn = document.getElementById('applyBtn');
            const resetBtn = document.getElementById('resetBtn');
            const arModel = document.getElementById('arModel');
            const statusText = document.getElementById('statusText');
            
            let panelVisible = true;
            
            // Default values
            const defaults = {
                lat: 6.819446,
                lon: 80.040257,
                height: 0,
                scale: 200
            };
            
            // Toggle panel visibility
            toggleBtn.addEventListener('click', () => {
                panelVisible = !panelVisible;
                if (panelVisible) {
                    controlPanel.classList.remove('hidden');
                    toggleBtn.classList.add('panel-visible');
                } else {
                    controlPanel.classList.add('hidden');
                    toggleBtn.classList.remove('panel-visible');
                }
            });
            
            // Update value displays
            heightSlider.addEventListener('input', (e) => {
                heightVal.textContent = e.target.value + 'm';
            });
            
            scaleSlider.addEventListener('input', (e) => {
                scaleVal.textContent = e.target.value;
            });
            
            // Apply changes
            applyBtn.addEventListener('click', () => {
                const lat = parseFloat(latInput.value);
                const lon = parseFloat(lonInput.value);
                const height = parseFloat(heightSlider.value);
                const scale = parseFloat(scaleSlider.value);
                
                // Update GPS position
                arModel.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);
                
                // Update position (height)
                arModel.setAttribute('position', `0 ${height} 0`);
                
                // Update scale
                arModel.setAttribute('scale', `${scale} ${scale} ${scale}`);
                
                statusText.textContent = 'Status: Updated ‚úì';
                console.log(`Updated: Lat=${lat}, Lon=${lon}, Height=${height}m, Scale=${scale}`);
                
                // Reset status after 2 seconds
                setTimeout(() => {
                    statusText.textContent = 'Status: Ready';
                }, 2000);
            });
            
            // Reset to defaults
            resetBtn.addEventListener('click', () => {
                latInput.value = defaults.lat;
                lonInput.value = defaults.lon;
                heightSlider.value = defaults.height;
                scaleSlider.value = defaults.scale;
                heightVal.textContent = defaults.height + 'm';
                scaleVal.textContent = defaults.scale;
                
                // Apply defaults
                arModel.setAttribute('gps-entity-place', `latitude: ${defaults.lat}; longitude: ${defaults.lon}`);
                arModel.setAttribute('position', `0 ${defaults.height} 0`);
                arModel.setAttribute('scale', `${defaults.scale} ${defaults.scale} ${defaults.scale}`);
                
                statusText.textContent = 'Status: Reset ‚úì';
                console.log('Reset to default values');
                
                setTimeout(() => {
                    statusText.textContent = 'Status: Ready';
                }, 2000);
            });
            
            // Log when scene loads
            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', () => {
                console.log('AR scene loaded');
                statusText.textContent = 'Status: Scene loaded ‚úì';
            });
            
            // Track user location for distance calculation
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLon = position.coords.longitude;
                        const targetLat = parseFloat(latInput.value);
                        const targetLon = parseFloat(lonInput.value);
                        
                        // Calculate distance (Haversine)
                        const R = 6371e3;
                        const œÜ1 = (userLat * Math.PI) / 180;
                        const œÜ2 = (targetLat * Math.PI) / 180;
                        const ŒîœÜ = ((targetLat - userLat) * Math.PI) / 180;
                        const ŒîŒª = ((targetLon - userLon) * Math.PI) / 180;
                        
                        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                                  Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        const distance = R * c;
                        
                        document.getElementById('distanceText').textContent = 
                            `Distance: ${distance.toFixed(1)}m`;
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    },
                    { enableHighAccuracy: true }
                );
            }
            
            // Mobile Camera Zoom Controls
            let initialDistance = 0;
            let initialZoom = 1;
            const camera = document.querySelector('a-camera');
            
            // Touch event handlers for pinch-to-zoom
            function handleTouchStart(e) {
                if (e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialZoom = camera.getAttribute('zoom') || 1;
                }
            }
            
            function handleTouchMove(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    if (initialDistance > 0) {
                        const zoomFactor = currentDistance / initialDistance;
                        const newZoom = Math.max(0.5, Math.min(3, initialZoom * zoomFactor));
                        
                        // Apply zoom to camera
                        camera.setAttribute('zoom', newZoom);
                        console.log('Camera zoom:', newZoom);
                    }
                }
            }
            
            function handleTouchEnd(e) {
                initialDistance = 0;
            }
            
            // Add touch event listeners to the scene
            scene.addEventListener('touchstart', handleTouchStart, { passive: false });
            scene.addEventListener('touchmove', handleTouchMove, { passive: false });
            scene.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // Mouse wheel zoom for desktop
            scene.addEventListener('wheel', (e) => {
                e.preventDefault();
                const currentZoom = camera.getAttribute('zoom') || 1;
                const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoom = Math.max(0.5, Math.min(3, currentZoom * zoomDelta));
                camera.setAttribute('zoom', newZoom);
                console.log('Camera zoom (wheel):', newZoom);
            });
            
            console.log('Mobile camera zoom controls initialized');
        </script>
    </body>
</html>
